# DiffDynamic 项目初始化与使用指南

## 目录

1. [快速开始（一条龙指南）](#快速开始一条龙指南) ⭐
2. [环境配置](#环境配置)
   - [Docker 环境（推荐）](#docker-环境推荐)
   - [WSL2 设置（Windows用户）](#wsl2-设置windows用户)
   - [Conda 环境创建](#conda-环境创建)
3. [依赖安装](#依赖安装)
4. [配置文件说明](#配置文件说明)
   - [梯度融合参数](#梯度融合参数)
   - [动态采样调度策略](#动态采样调度策略)
   - [评估配置](#评估配置)
5. [脚本使用](#脚本使用)
   - [scripts/sample_diffusion.py](#scriptssample_diffusionpy)
   - [evaluate_pt_with_correct_reconstruct.py](#evaluate_pt_with_correct_reconstructpy)
   - [batch_sample_all.py](#batch_sample_allpy)

---

## 快速开始（一条龙指南）⭐

### 方式一：使用 Docker（推荐，最简单）

**步骤 1：安装 Docker 并拉取 Ubuntu 20.04 镜像**

```bash
# 运行自动安装脚本（如果 Docker 未安装）
bash setup_docker_ubuntu.sh

# 或者手动安装 Docker（如果脚本无法运行）
# 检查 Docker 是否已安装
docker --version

# 如果未安装，请参考下面的 Docker 安装指南
```
cd /home/user/Desktop/Ye/DiffDynamic
bash start_docker.sh
**步骤 2：启动 Docker 容器并进入项目环境**

```bash
# 启动一个交互式 Ubuntu 20.04 容器，挂载项目目录
sudo docker run -it \
    --name diffdynamic \
    -v $(pwd):/workspace \
    -w /workspace \
    ubuntu:20.04 \
    /bin/bash
./start_docker.sh
# 如果容器已存在，可以重新启动并进入
sudo docker start diffdynamic
sudo docker exec -it diffdynamic /bin/bash
```

**步骤 3：在容器内安装依赖**

```bash
# 更新包管理器
apt-get update

# 安装基础工具
apt-get install -y python3 python3-pip wget curl git

# 安装 Miniconda（推荐）
wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
bash Miniconda3-latest-Linux-x86_64.sh -b -p /opt/conda
export PATH=/opt/conda/bin:$PATH

# 创建 Conda 环境
conda create -n diffdynamic python=3.8 -y
conda activate diffdynamic

# 安装项目依赖（参考下面的依赖安装部分）
pip install torch==1.12.1+cu116 torchvision==0.13.1+cu116 torchaudio==0.12.1 \
    --extra-index-url https://download.pytorch.org/whl/cu116
pip install torch-scatter torch-cluster torch-sparse torch-spline-conv \
    -f https://data.pyg.org/whl/torch-1.12.1+cu116.html
conda install pyg -c pyg -y
pip install torch_geometric==2.2.0 rdkit-pypi openbabel-py

# 设置环境变量
export PYTHONPATH=$PWD:$PYTHONPATH
```

**步骤 4：运行项目**

```bash
# 激活环境
conda activate diffdynamic

# 运行采样示例
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0
```

### 方式二：本地环境（WSL2/Conda）

**步骤 1：设置 WSL2（仅 Windows 用户）**

```bash
wsl --set-version Ubuntu-20.04 2
```

**步骤 2：创建 Conda 环境**

```bash
conda create -n diffdynamic python=3.8
conda activate diffdynamic
cd /path/to/DiffDynamic
```
cd /home/user/Desktop/Ye/DiffDynamic
bash start_docker.sh
# 如果 conda 环境未自动激活，手动激活
source /opt/conda/etc/profile.d/conda.sh
conda activate diffdynamic

# 进入工作目录
cd /workspace

# 运行批量采样和评估（根据你的配置）
python3 batch_sampleandeval_parallel.py --start 0 --end 10 --gpus "1-3" --num_cpu_cores 2
**步骤 3：安装依赖**
cd /home/user/Desktop/Ye/DiffDynamic
bash start_docker.sh

```bash
# 安装 PyTorch
pip install torch==1.12.1+cu116 torchvision==0.13.1+cu116 torchaudio==0.12.1 \
    --extra-index-url https://download.pytorch.org/whl/cu116

# 安装 PyTorch Geometric
pip install torch-scatter torch-cluster torch-sparse torch-spline-conv \
    -f https://data.pyg.org/whl/torch-1.12.1+cu116.html
conda install pyg -c pyg
pip install torch_geometric==2.2.0 rdkit-pypi openbabel-py

# 设置环境变量
export PYTHONPATH=$PWD:$PYTHONPATH
```

**步骤 4：运行项目**

```bash
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0
```

### 快速验证安装

```bash
# 验证关键依赖
python3 -c "import torch; print(f'PyTorch: {torch.__version__}')"
python3 -c "import torch_geometric; print('PyG OK')"
python3 -c "import rdkit; print('RDKit OK')"

# 验证项目结构
ls configs/sampling.yml  # 应该存在
ls scripts/sample_diffusion.py  # 应该存在
```

---

## 环境配置

### Docker 环境（推荐）

Docker 提供了隔离、可复现的环境，推荐用于开发和部署。

#### Docker 安装

**Linux 系统：**

```bash
# 使用自动安装脚本（推荐）
bash setup_docker_ubuntu.sh

# 或手动安装
# 1. 更新包索引
sudo apt-get update

# 2. 安装必要的依赖
sudo apt-get install -y \
    ca-certificates \
    curl \
    gnupg \
    lsb-release

# 3. 添加 Docker 官方 GPG 密钥
sudo mkdir -p /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

# 4. 设置 Docker 仓库
echo \
  "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 5. 安装 Docker Engine
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 6. 启动 Docker 服务
sudo systemctl start docker
sudo systemctl enable docker

# 7. 将用户添加到 docker 组（避免每次使用 sudo）
sudo usermod -aG docker $USER
newgrp docker
```

**验证安装：**

```bash
docker --version
docker ps
```

#### 拉取 Ubuntu 20.04 镜像

```bash
# 拉取 Ubuntu 20.04 镜像
docker pull ubuntu:20.04

# 验证镜像
docker images ubuntu:20.04
```

#### 启动 Docker 容器

**基本启动（交互式）：**

```bash
# 启动一个交互式容器
docker run -it \
    --name diffdynamic \
    -v $(pwd):/workspace \
    -w /workspace \
    ubuntu:20.04 \
    /bin/bash
```

**参数说明：**
- `-it`：交互式终端
- `--name diffdynamic`：容器名称
- `-v $(pwd):/workspace`：将当前目录挂载到容器的 `/workspace`
- `-w /workspace`：设置工作目录
- `ubuntu:20.04`：使用的镜像

**带 GPU 支持（如果需要在容器内使用 GPU）：**

```bash
# 需要先安装 nvidia-docker2
sudo apt-get install -y nvidia-docker2
sudo systemctl restart docker

# 启动带 GPU 的容器
docker run -it \
    --name diffdynamic \
    --gpus all \
    -v $(pwd):/workspace \
    -w /workspace \
    ubuntu:20.04 \
    /bin/bash
```

**容器管理：**

```bash
# 查看运行中的容器
docker ps

# 查看所有容器（包括已停止的）
docker ps -a

# 启动已存在的容器
docker start diffdynamic

# 进入运行中的容器
docker exec -it diffdynamic /bin/bash

# 停止容器
docker stop diffdynamic

# 删除容器
docker rm diffdynamic

# 删除镜像
docker rmi ubuntu:20.04
```

**在已运行的容器中打开新终端并行执行命令：**

当容器已经在运行时，你可以在**新的终端窗口**中使用 `docker exec` 命令进入同一个容器，实现并行执行多个任务：

```bash
# 方法1：在新终端中进入容器的交互式 shell（推荐）
# 打开新的终端窗口，然后执行：
sudo docker exec -it diffdynamic /bin/bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    exec /bin/bash
"

# 方法2：在新终端中直接执行单个命令（非交互式）
sudo docker exec diffdynamic bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    python scripts/sample_diffusion.py configs/sampling.yml --data_id 0
"

# 方法3：在新终端中执行后台任务（适合长时间运行的任务）
sudo docker exec -d diffdynamic bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    python scripts/sample_diffusion.py configs/sampling.yml --data_id 0 > /workspace/log_0.txt 2>&1
"
```

**并行执行示例：**

假设你想在多个终端中同时运行不同的任务：

```bash
# 终端1：运行 data_id=0 的采样
sudo docker exec -it diffdynamic /bin/bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    exec /bin/bash
"
# 然后在容器内执行：
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0

# 终端2：运行 data_id=1 的采样（打开新终端窗口）
sudo docker exec -it diffdynamic /bin/bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    exec /bin/bash
"
# 然后在容器内执行：
python scripts/sample_diffusion.py configs/sampling.yml --data_id 1

# 终端3：运行 data_id=2 的采样（再打开一个新终端窗口）
sudo docker exec -it diffdynamic /bin/bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    exec /bin/bash
"
# 然后在容器内执行：
python scripts/sample_diffusion.py configs/sampling.yml --data_id 2
```

**注意事项：**
- 每个 `docker exec` 命令都会创建一个新的进程，可以并行运行
- 使用 `-it` 参数可以获得交互式终端
- 使用 `-d` 参数可以在后台运行（不占用终端）
- 所有终端共享同一个容器的文件系统和环境
- 如果使用 GPU，确保多个进程不会同时竞争同一块 GPU（可以使用 `--device` 参数指定不同的 GPU）

#### 终端启动 Docker 并进入 Conda 环境（完整指南）

**步骤 1：进入项目目录**

```bash
cd /home/user/Desktop/Ye/DiffDynamic
```

**步骤 2：检查容器状态**

```bash
# 查看容器是否存在
sudo docker ps -a | grep diffdynamic

# 如果容器不存在，创建并启动容器（后台运行）
sudo docker run -d --name diffdynamic \
    -v $(pwd):/workspace \
    -w /workspace \
    ubuntu:20.04 \
    tail -f /dev/null

# 如果容器已存在但已停止，启动它
sudo docker start diffdynamic
```

**步骤 3：在容器内安装 Conda（首次使用需要）**

```bash
# 更新包管理器并安装基础工具
sudo docker exec diffdynamic bash -c "
    apt-get update && \
    apt-get install -y wget bzip2 ca-certificates libglib2.0-0 libxext6 libsm6 libxrender1 git
"

# 下载并安装 Miniconda
sudo docker exec diffdynamic bash -c "
    cd /tmp && \
    wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh && \
    bash miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh && \
    /opt/conda/bin/conda clean -tipsy
"

# 创建 diffdynamic 环境
sudo docker exec diffdynamic bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda create -n diffdynamic python=3.8 -y
"
```

**步骤 4：进入容器并激活 Conda 环境**

```bash
# 进入容器并自动激活 diffdynamic 环境
sudo docker exec -it diffdynamic /bin/bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    exec /bin/bash
"
```

**一键启动命令（推荐）：**

将以下命令保存为别名，方便快速启动：

```bash
# 添加到 ~/.bashrc（可选）
alias docker-diffdynamic='sudo docker exec -it diffdynamic /bin/bash -c "source /opt/conda/etc/profile.d/conda.sh && conda activate diffdynamic && cd /workspace && export PYTHONPATH=/workspace:\$PYTHONPATH && exec /bin/bash"'

# 然后直接运行
docker-diffdynamic
```

**完整流程示例：**

```bash
# 1. 进入项目目录
cd /home/user/Desktop/Ye/DiffDynamic

# 2. 检查容器是否存在
sudo docker ps -a | grep diffdynamic

# 3. 如果不存在，创建容器（后台运行）
sudo docker run -d --name diffdynamic \
    -v $(pwd):/workspace \
    -w /workspace \
    ubuntu:20.04 \
    tail -f /dev/null

# 4. 如果容器已停止，启动它
sudo docker start diffdynamic

# 5. 进入容器并激活环境
sudo docker exec -it diffdynamic /bin/bash -c "
    source /opt/conda/etc/profile.d/conda.sh && \
    conda activate diffdynamic && \
    cd /workspace && \
    export PYTHONPATH=/workspace:\$PYTHONPATH && \
    exec /bin/bash
"
```

**验证环境：**

进入容器后，运行以下命令验证：

```bash
# 检查 Python 版本
python --version

# 检查 Conda 环境
conda info --envs

# 检查当前激活的环境
conda env list

# 检查项目文件
ls -la /workspace

# 检查 PYTHONPATH
echo $PYTHONPATH
```

**常见问题解决：**

1. **如果提示 "Conda 未安装"**：
   ```bash
   # 重新执行步骤 3 安装 Conda
   ```

2. **如果提示 "环境 diffdynamic 不存在"**：
   ```bash
   # 在容器内创建环境
   sudo docker exec diffdynamic bash -c "
       source /opt/conda/etc/profile.d/conda.sh && \
       conda create -n diffdynamic python=3.8 -y
   "
   ```

3. **如果容器无法启动**：
   ```bash
   # 删除旧容器并重新创建
   sudo docker rm diffdynamic
   sudo docker run -d --name diffdynamic \
       -v $(pwd):/workspace \
       -w /workspace \
       ubuntu:20.04 \
       tail -f /dev/null
   ```

4. **避免每次使用 sudo**：
   ```bash
   # 将用户添加到 docker 组
   sudo usermod -aG docker $USER
   newgrp docker
   # 之后就可以直接使用 docker 命令，无需 sudo
   ```

#### Docker 网络配置（如遇网络问题）

如果拉取镜像时遇到网络问题，可以配置 Docker 使用国内镜像源：

```bash
# 编辑 Docker 配置文件
sudo nano /etc/docker/daemon.json

# 添加以下内容（选择一个可用的镜像源）
{
  "registry-mirrors": [
    "https://docker.mirror.sjtu.edu.cn",
    "https://hub-mirror.c.163.com",
    "https://mirror.baidubce.com"
  ],
  "ipv6": false,
  "dns": ["8.8.8.8", "8.8.4.4"]
}

# 重启 Docker 服务
sudo systemctl restart docker
```

#### Docker Compose（可选，用于复杂环境）

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  diffdynamic:
    image: ubuntu:20.04
    container_name: diffdynamic
    volumes:
      - .:/workspace
    working_dir: /workspace
    stdin_open: true
    tty: true
    command: /bin/bash
```

使用方式：

```bash
# 启动容器
docker-compose up -d

# 进入容器
docker-compose exec diffdynamic /bin/bash

# 停止容器
docker-compose down
```

### WSL2 设置（Windows用户）

```bash
# 将指定发行版升级为WSL2（替换为你的发行版名称，如Ubuntu-20.04）
wsl --set-version Ubuntu-20.04 2

# 可选：设置WSL2为默认版本（后续安装的发行版自动为WSL2）
wsl --set-default-version 2
```

### Conda 环境创建

```bash
conda create -n diffdynamic python=3.8
conda activate diffdynamic
cd /mnt/e/DiffDynamic
```
---

## 依赖安装

### PyTorch 及相关库

```bash
# 安装 PyTorch (CUDA 11.6)
pip install torch==1.12.1+cu116 torchvision==0.13.1+cu116 torchaudio==0.12.1 \
    --extra-index-url https://download.pytorch.org/whl/cu116

# 安装 PyTorch Geometric 相关库
pip install torch-scatter torch-cluster torch-sparse torch-spline-conv \
    -f https://data.pyg.org/whl/torch-1.12.1+cu116.html

conda install pyg -c pyg
pip install torch_geometric==2.2.0 rdkit-pypi 
```

### 环境变量设置

```bash
# 设置PYTHONPATH以便脚本能找到项目内的utils等模块
export PYTHONPATH=$PWD:$PYTHONPATH
```

### 依赖验证

```bash
# 验证关键依赖是否安装成功
python3 -c "import vina; print('vina OK')"
python3 -c "import meeko; print('meeko OK')"
python3 -c "import openbabel; print('openbabel OK')"
python3 -c "import AutoDockTools; print('AutoDockTools OK')"
```

---

## 配置文件说明

项目使用 `configs/sampling.yml` 作为主要的配置文件，控制采样、模型和评估的行为。

### 梯度融合参数

梯度融合（Gradient Fusion）用于平衡全局和局部梯度信息：

```yaml
grad_fusion_lambda:
  mode: linear  # 调度模式：'linear', 'exponential', 'adaptive', 'time'
  start: 0.8   # 初始 lambda 值（更依赖全局梯度，但不完全依赖，避免结构不稳定）
  end: 0.3     # 最终 lambda 值（更依赖局部梯度，但保持一定全局信息，避免过度优化）
```

**参数说明**：
- `start: 0.8`：采样初期更依赖全局梯度（0.8），但保留局部信息（0.2），避免结构不稳定
- `end: 0.3`：采样后期更依赖局部梯度（0.7），但保持一定全局信息（0.3），避免过度优化
- 线性调度：从 0.8 线性递减到 0.3，平滑过渡

### 动态采样调度策略

动态采样包含两个阶段：**大步探索阶段**（large_step）和**精炼阶段**（refine）。

#### 调度类型

支持三种调度类型：

1. **`lambda`**：自适应调度，根据时间步自动调整步长
2. **`linear`**：线性调度，步长线性递减（推荐用于大步阶段）
3. **固定步长**：其他值，使用固定的 `stride` 间隔

#### 大步探索阶段（large_step）

当前配置使用 **线性调度**（`schedule: linear`）：

```yaml
large_step:
  schedule: linear              # 使用线性调度
  step_size: 0.8                # 更新步幅（减小以避免分子断连）
  time_lower: 750               # 下限时间步（上限为 num_steps-1，即 999）
  linear_step_upper: 30.0       # 第一步的跳步步长（上限）
  linear_step_lower: 10.0       # 最后一步的跳步步长（下限）
```

**线性调度计算**：
- 程序自动计算：`linear_coeff_a = 上限 - 下限 = 30 - 10 = 20`
- `linear_coeff_b = 下限 = 10`
- 步长公式：`step_size = a * progress + b`
  - `progress`：剩余时间范围 / 初始时间范围（从 1.0 到 0.0）
  - 第一步（progress=1.0）：`step_size = 20 + 10 = 30`（上限）
  - 最后一步（progress=0.0）：`step_size = 10`（下限）

**时间调度示例**：
- `lambda`：999→899→807→722→644→600（共 6 步，自适应步长）
- `linear`（上限=30, 下限=10）：999→969→939→...→750（步长从 30 线性递减到 10）
- `fixed`：999→984→969→...→750（固定 stride=15，约 17 步）

#### 精炼阶段（refine）

当前配置使用 **自适应调度**（`schedule: lambda`）：

```yaml
refine:
  schedule: lambda              # 使用自适应调度
  step_size: 0.2                # 精炼步幅
  time_upper: 750               # 上限时间步（起始时间）
  time_lower: 0                 # 下限时间步（结束时间）
  lambda_coeff_a: 40.0          # Lambda 调度参数 a（仅在 schedule='lambda' 时使用）
  lambda_coeff_b: 5.0           # Lambda 调度参数 b（仅在 schedule='lambda' 时使用）
```

**如果使用线性调度**（可选）：

```yaml
refine:
  schedule: linear
  linear_step_upper: 15.0       # 第一步的跳步步长
  linear_step_lower: 5.0        # 最后一步的跳步步长
```

**时间调度示例**：
- `lambda`：750→...→5→0（约 44 步，自适应步长）
- `linear`（上限=15, 下限=5）：750→745→740→...→5→0（步长从 15 线性递减到 5）
- `fixed`：750→742→734→...→6→0（固定 stride=8，约 94 步）

### 评估配置

```yaml
docking:
  enable: false  # 是否执行自动对接（设为false后，使用batch_sample_all.py --run_eval统一评估）
  vina_exhaustiveness: 8  # Vina 搜索强度
```

**推荐配置**：
- `enable: false`：采样时不自动评估，避免重复评估
- 使用 `batch_sample_all.py --run_eval` 统一批量评估，提高效率

**如果需要在采样时自动评估**：
- 将 `enable` 改为 `true`
- 或使用 `batch_sample_all.py` 时不添加 `--skip_generation_eval` 参数

---

## 脚本使用

### scripts/sample_diffusion.py

用于从给定的蛋白质口袋生成配体分子，是项目中最基础的采样脚本。

#### 基本用法

```bash
# 基本用法：从标准口袋进行采样（data_id 范围：0-99）
python scripts/sample_diffusion.py configs/sampling.yml --data_id {i}

# 示例：采样 data_id=0
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0

# 示例：采样 data_id=5
python3 scripts/sample_diffusion.py configs/sampling.yml --data_id 92
```

**注意**：`{i}` 应该替换为实际的数据索引，范围在 0 到 99 之间（测试集范围）。

#### 参数说明

| 参数 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `config` | str | **必需** | 配置文件路径（如：`configs/sampling.yml`） |
| `-i, --data_id` | int | None | 指定测试数据索引（0-99，默认：0） |
| `--device` | str | `cuda:0` | 指定运行设备（如：`cuda:0`, `cuda:1`） |
| `--batch_size` | int | 100 | 批量大小（每次生成的样本数） |
| `--result_path` | str | `./outputs` | 结果输出目录 |
| `--mode` | str | None | 采样模式：`baseline` 或 `dynamic`（默认：从配置文件读取） |

#### 使用示例

**示例1：基本采样（使用默认设备）**

```bash
# 采样 data_id=0，使用默认设备 cuda:0
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0
```

**示例2：指定GPU设备**

```bash
# 使用 cuda:1 进行采样
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0 --device cuda:1
```

**示例3：调整批量大小**

```bash
# 每次生成50个样本
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0 --batch_size 50
```

**示例4：指定采样模式**

```bash
# 使用 baseline 模式
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0 --mode baseline

# 使用 dynamic 模式
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0 --mode dynamic
```

**示例5：指定输出目录**

```bash
# 将结果保存到自定义目录
python scripts/sample_diffusion.py configs/sampling.yml --data_id 0 --result_path ./my_outputs
```

**示例6：批量采样多个 data_id**

```bash
# 使用循环批量采样（bash）
for i in {0..99}; do
    python scripts/sample_diffusion.py configs/sampling.yml --data_id $i
done

# 或者使用 Python 循环
for i in range(100):
    os.system(f"python scripts/sample_diffusion.py configs/sampling.yml --data_id {i}")
```

#### 输出说明

采样完成后会生成以下文件：

1. **采样结果文件**：`outputs/result_{data_id}_{timestamp}.pt`
   - 包含生成的分子坐标（`pred_ligand_pos`）和原子类型（`pred_ligand_v`）
   - 包含原始数据信息（`data`）
   - 包含额外信息（`extra_info`，如 `data_id`）

2. **日志信息**：控制台输出采样进度和统计信息

#### 注意事项

1. **data_id 范围**：测试集的 `data_id` 范围是 0-99，超出此范围可能导致错误
2. **配置文件**：确保 `configs/sampling.yml` 文件存在且配置正确
3. **设备选择**：使用 `--device` 参数指定可用的 GPU 设备
4. **批量大小**：`--batch_size` 影响每次生成的样本数量，较大的值会占用更多显存
5. **采样模式**：如果不指定 `--mode`，将从配置文件中读取默认模式

#### 与批量脚本的关系

`batch_sample_all.py` 脚本内部就是调用 `scripts/sample_diffusion.py` 来执行批量采样。如果只需要采样单个或少量样本，可以直接使用此脚本；如果需要批量采样多个 `data_id`，建议使用 `batch_sample_all.py`。

---

### evaluate_pt_with_correct_reconstruct.py

用于评估 `.pt` 文件中生成的分子，包括分子重建、化学指标计算和 AutoDock Vina 对接评分。

#### 基本用法

```bash
python3 evaluate_pt_with_correct_reconstruct.py \
    /mnt/e/DiffDynamic/outputs/result_92_20251208_123624.pt\
 
