# 分子评估流程图可视化使用说明

## 概述

`visualize_molecule_evaluation_flow.py` 是一个用于生成分子评估流程图的Python脚本。它根据 `分子评估流程文档.md` 中的流程描述，自动生成可视化的流程图。

## 功能特点

- 📊 完整的流程图展示，从输入到输出的所有步骤
- 🎨 使用不同颜色区分不同类型的步骤（开始、处理、评估、计算、保存等）
- 📝 详细的子步骤展示（评估步骤和评分计算步骤）
- 🔄 循环和判断节点的清晰表示
- 📄 支持PNG和PDF两种输出格式

## 使用方法

### 基本用法

```bash
# 使用默认文件名（molecule_evaluation_flowchart.png）
python visualize_molecule_evaluation_flow.py

# 指定输出文件名
python visualize_molecule_evaluation_flow.py my_flowchart.png

# 指定完整路径
python visualize_molecule_evaluation_flow.py ./outputs/flowchart.png
```

### 输出格式

脚本会自动生成两种格式：

1. **PNG格式** (`.png`)
   - 高分辨率（300 DPI）
   - 适合在文档中插入
   - 文件较大，但质量高

2. **PDF格式** (`.pdf`)
   - 矢量图格式
   - 可无限缩放不失真
   - 适合打印和演示

### 在Python代码中使用

```python
from visualize_molecule_evaluation_flow import create_flowchart, save_flowchart, show_flowchart

# 生成并保存流程图
save_flowchart('my_flowchart.png', dpi=300)

# 在交互式环境中显示
show_flowchart()
```

## 流程图说明

### 颜色含义

- 🟢 **绿色** - 开始/结束节点
- 🔵 **蓝色** - 处理步骤（加载、验证、准备等）
- 🟣 **紫色** - 评估步骤（化学指标、对接等）
- 🔴 **红色** - 计算步骤（评分计算）
- 🔵 **青色** - 保存步骤
- 🟠 **橙色** - 判断节点（菱形）
- 🟤 **深橙** - 错误处理

### 主要流程步骤

1. **入口和初始化** - 解析参数，验证输入
2. **加载和验证数据** - 从.pt文件加载分子数据
3. **准备评估环境** - 创建输出目录
4. **分子处理主循环** - 遍历每个分子
5. **分子重建** - 使用OpenBabel重建3D结构
6. **分子评估** - 包含13个子步骤（左侧详细展示）
7. **综合评分计算** - 包含4个子步骤（右侧详细展示）
8. **生成分子身份证** - 生成唯一标识符
9. **保存结果** - 保存SDF文件和评估结果
10. **最终统计和保存** - 生成Excel和JSON文件

### 详细子步骤

**评估步骤（左侧）**:
- 8.1 RDKit验证
- 8.2 化学指标（QED, SA, logP, Lipinski）
- 8.3 TPSA计算
- 8.4 基础结构信息
- 8.5 PAINS检测
- 8.6 稳定性评估
- 8.7 Tanimoto相似度
- 8.8 RDKit RMSD
- 8.9 构象能量
- 8.10 Lilly Medchem Rules
- 8.11 生成SMILES
- 8.12 结构指标（JSD分布）
- 8.13 AutoDock Vina对接

**评分计算步骤（右侧）**:
- 9.1 Vina亲和力归一化
- 9.2 基础分加权和
- 9.3 惩罚系数
- 9.4 最终得分

## 依赖要求

```bash
pip install matplotlib numpy
```

## 自定义修改

如果需要修改流程图：

1. **修改颜色**: 编辑 `colors` 字典
2. **添加步骤**: 在 `create_flowchart()` 函数中添加新的 `create_box()` 调用
3. **调整布局**: 修改 `xlim`、`ylim` 和各个框的位置坐标
4. **修改字体**: 调整 `fontsize` 参数

## 注意事项

1. **中文字体**: 脚本会自动尝试使用系统中可用的中文字体。如果中文显示为方块，请安装中文字体（如SimHei、Microsoft YaHei等）

2. **图片大小**: 流程图较大（20×28英寸），适合打印或高分辨率显示。如果需要较小的图片，可以：
   - 降低DPI（如150）
   - 减小figsize参数
   - 使用PDF格式并缩放

3. **性能**: 生成流程图可能需要几秒钟，特别是高分辨率PNG格式

## 示例输出

运行脚本后，会在当前目录生成：
- `molecule_evaluation_flowchart.png` - PNG格式流程图
- `molecule_evaluation_flowchart.pdf` - PDF格式流程图

## 故障排除

### 问题：中文显示为方块

**解决方案**:
1. 安装中文字体（Windows通常自带）
2. 修改 `plt.rcParams['font.sans-serif']` 列表，添加系统中已安装的中文字体名称

### 问题：图片太大或太小

**解决方案**:
- 修改 `figsize` 参数（第20行）
- 调整DPI参数（`save_flowchart()` 函数）

### 问题：某些步骤显示不全

**解决方案**:
- 调整 `ax.set_xlim()` 和 `ax.set_ylim()` 的范围
- 减小字体大小或缩短文本

## 更新日志

- **v1.0** (2024): 初始版本，支持PNG和PDF输出

---

**相关文档**: 
- `分子评估流程文档.md` - 详细的流程说明文档
- `evaluate_pt_with_correct_reconstruct.py` - 实际评估代码


